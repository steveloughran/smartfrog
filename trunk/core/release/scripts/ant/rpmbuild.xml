<project name="rpmbuild" basedir=".">

  <!--
  (C) Copyright 2008 Hewlett-Packard Development Company, LP

   This library is free software; you can redistribute it and/or
   modify it under the terms of the GNU Lesser General Public
   License as published by the Free Software Foundation; either
   version 2.1 of the License, or (at your option) any later version.

   This library is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
   Lesser General Public License for more details.

   You should have received a copy of the GNU Lesser General Public
   License along with this library; if not, write to the Free Software
   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA

   For more information: www.smartfrog.org

  -->

  <description>
    This is a build file that is designed to be redistributed as part of a tar file,
    then executed to create a new RPM with signed artifacts.

    It requires
    * Ant1.7.0+
    * A linux system with rpmbuild on the path

    It looks for security properties in a file called security.properties
    in (and in the current order)
     - the current directory
     - one level up
     - ~/.ant
     
   if sign.jars is set: jars will be signed, and the security keys
   must be provided.
   if no.unsigned.jars is set, then jars are not signed.

  </description>

  <!--Load the properties file, fail if it is missing-->
  <loadproperties srcFile="rpmbuild.properties" />

  <!--load in a security properties file-->; look in . and ~/.ant
  <property file="security.properties" />
  <property file="../security.properties"/>
  <property file="${user.home}/.ant/security.properties"/>
  <property name="rpm.build.dir" location="${basedir}" />
  
  <!--
  
  -->
  <target name="init-rpm"/>


  <target name="rpmmacros" depends="init-rpm">
    <echo file="${user.home}/.rpmmacros">
      #GENERATED by rpmmacros task in ${basedir}
      %_topdir ${basedir}
    </echo>
  </target>

  <target name="ready-to-sign" depends="init-rpm" if="sign.jars">
      
      
  </target>


  <target name="signjars" depends="ready-to-sign" >
      
  </target>
  <target name="ready-to-rpm" depends="prepare-binary-rpm,rpmmacros" />


  <target name="rpm" depends="gzip-rpm" description="create the gzipped RPM"/>

  <target name="build-rpm" depends="ready-to-rpm"
      if="has.rpm.tools"
      description="create an RPM file of the core smartfrog libraries">
    <rpm
        specFile="smartfrog.spec"
        topDir="${rpm.image.dir}"
        cleanBuildDir="true"
        failOnError="true"/>
  </target>

  <target name="ready-to-prepare-binary-rpm" 
    depends="prepare-rpm-build-file,rpmmacros,signjars" />


  <target name="prepare-binary-rpm"
      depends="ready-to-prepare-binary-rpm">
    <mkdir dir="${build.rpm.dir}/root${rpm.log.dir}"/>
    <exec executable="tar" failonerror="true"
        dir="${build.rpm.dir}/root/">
      <arg value="cvvf"/>
      <arg file="${smartfrog.rpmfiles.tar}"/>
      <arg value="etc"/>
      <arg value="opt"/>
      <arg value="var"/>
      <arg value="usr"/>
    </exec>
    <!--
       <sf-tar destfile="${smartfrog.rpmfiles.tar}" >
         <fileset dir="${build.rpm.dir}/root/" includes="**/*" />
       </sf-tar>
    -->
    <!-- now we have a sanity check -->
    <loadresource property="homepage">
      <tarentry archive="${smartfrog.rpmfiles.tar}"
          name="etc/sysconfig/smartfrog"/>
    </loadresource>
    <gzip src="${smartfrog.rpmfiles.tar}"
        destfile="${smartfrog.rpmfiles.tar.gz}"/>
  </target>


</project>