/** (C) Copyright 2006 Hewlett-Packard Development Company, LP

 This library is free software; you can redistribute it and/or
 modify it under the terms of the GNU Lesser General Public
 License as published by the Free Software Foundation; either
 version 2.1 of the License, or (at your option) any later version.

 This library is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 Lesser General Public License for more details.

 You should have received a copy of the GNU Lesser General Public
 License along with this library; if not, write to the Free Software
 Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA

 For more information: www.smartfrog.org

 */


/*
 components to set up hsqldb testing
 */

#include "/org/smartfrog/services/database/test/system/core/components.sf";
#include "/org/smartfrog/services/database/mysql/components.sf";
#include "/org/smartfrog/sfcore/workflow/components.sf"
#include "/org/smartfrog/services/filesystem/components.sf"

Settings extends {
   memorydb "memory";
   testUser "testUser";
   testPass "secret";
   socketpath "/tmp/mysqld.sock";

 }

 Mysqld extends mysqldaemon {
/*
  shouldTerminate false;
  terminateOnFailure false;
*/
  skip-innodb true;
  skip-grant-tables true;
  skip-networking true;
  logLevel 5;
}

 DiaryBinding extends MysqlTargetedBinding {
   database "diary";
 }

 TestUserBinding extends DiaryBinding {
   username Settings:testUser;
   password Settings:testPass;
 }

 Datadir extends TempDirWithCleanup {
  prefix "mysql";
 }

 DatabaseAndBinding extends Compound {

      datadir extends Datadir;


      mysqld extends Mysqld {
        datadir LAZY PARENT:datadir:absolutePath;
        basedir datadir;
      }

      //binding extends DiaryBinding;
      binding extends MysqlBinding;

  }

  /**
   * how long should we give mysql before giving up?
   */
  mysql_startup_delay 5000;


  BlockForMysqlConnection extends BlockForJdbcConnection {
   timeout mysql_startup_delay ;
  }

  BlockForMysqlLive extends FailingWaitFor {
    database TBD;
    condition extends IsMysqlLive {
      database LAZY PARENT:database;
    }
   interval 200;
   timeout mysql_startup_delay;
  }


MysqlTest extends TestCompound {

    description "test compound for mysql tests";

    sfShouldTerminate false;

    action extends DatabaseAndBinding ;

    database LAZY action:binding;

    tests extends Sequence {
    }

 }


 sfConfig extends Compound {


    mysqld extends Mysqld;

    -- extends mysqladmin-status {
      socketpath Settings:socketpath;
    }

    -- extends mysqladmin-shutdown {
      socketpath Settings:socketpath;
    }

    TestUserBinding;

}