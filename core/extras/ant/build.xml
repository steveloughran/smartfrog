<?xml version="1.0"?>
<project name="ant_tasks" default="default" basedir=".">
  
<description>
  Build file for Ant tasks for Smartfrog

  This build file is Ant1.6+ only. Do not complain when it breaks
  on Ant1.5! 
  
  To build and run the tests, you need ant-testutil.jar, which you get
  by running "ant test-jar" in Ant
  
</description>

<property name="root.dir" location="../.."  />

<!-- Import common stuff -->
<import file="${root.dir}/common.xml"/>

  <target name="init" 
    depends="init-common,verify-smartfrog,init-standard-output-dirs">
    <property name="src.dir" location="src"/>
    <property name="target.name" value="{smartfrog.tasks.name}"/>
    <property name="target.jar" location="${smartfrog.tasks.jar}" />
    <condition property="system.tests.enabled">
      <istrue value="${system.tests}"/>
    </condition>    
    <property name="system.tests" value="true" />
    <condition property="system.tests.enabled">
      <not>
      <istrue value="${system.tests}"/>
      </not>
    </condition>   
    <echo>system.tests.enabled=${system.tests.enabled}</echo>
  </target>
    


  <target name="compile" depends="init">
    <sf-javac-with-ant 
      srcdir="${src.dir}"
      destdir="${build.classes.dir}"
      classpathref="smartfrog.classpath"
      >
    </sf-javac-with-ant>
    <copy-useful-files src="${src.dir}" dest="${build.classes.dir}" />
  </target>
  
  <target name="dist" depends="compile"
    description="make a distribution">
    <jar destfile="${target.jar}">
      <fileset dir="${build.classes.dir}" includes="**/*" />
    </jar>
  </target>
  
  <target name="test1" depends="dist,use-smartfrog-tasks">
    <sf-parse />
    <parallel>
      <sf-startdaemon 
        taskTimeout="30"
        classpathref="smartfrog.tasks.classpath"
        />
      <sequential>
        <sleep seconds="5"/>
        <sf-stopdaemon hostname="localhost"
          failonerror="true"
          classpathref="smartfrog.tasks.classpath"/>
      </sequential>
    </parallel>
    
  </target>
  
  <target name="stopdaemon" depends="dist,use-smartfrog-tasks">
    <sf-stopdaemon 
      classpathref="smartfrog.tasks.classpath"/>
  </target>
  
  <target name="default" depends="dist,test">
    <!-- todo -->
  </target>  
  
  <target name="find-testutil" depends="init">
    <property name="testutil.jar" 
      location="${ant.home}/build/lib/ant-testutil.jar"/>
    <path id="testutil.classpath">
      <pathelement location="${testutil.jar}"/>
    </path>
    
    <available property="testutil.found"
      classname="org.apache.tools.ant.BuildFileTest" 
      classpathref="testutil.classpath"
      ignoresystemclasses="false"/>
  </target>

  <target name="require-testutil" depends="find-testutil">
    <fail unless="testutil.found" >Could not find ${testutil.jar}</fail>
  </target>

  
  <target name="want-testutil" unless="testutil.found" depends="find-testutil">
    <echo level="error">
    Ant testutil classes not found in ${testutil.jar}
    The dependent stages of this build will be skipped.
    To build this file, run "ant test-jar" in 
    ant's source directory,
    Alternatively, retrieve it from Gump: 
    http://gump.covalent.net/jars/latest/ant/
    Note that the version of ant-testutil.jar should
    match the version of ant used. 
    </echo>
  </target>
  
  <target name="compile-tests" 
      depends="init,want-testutil,dist,use-smartfrog-tasks"
      if="testutil.found">
      <!-- set up a new path with the tasks and testutil -->
    <property name="test.src.dir" location="test/files"/>
    <path id="tests.compile.classpath">
      <path refid="smartfrog.classpath"/>
      <pathelement location="${smartfrog.tasks.jar}"/>
      <path refid="testutil.classpath"/>
    </path>
    
    <sf-javac-with-ant 
      srcdir="${test.src.dir}"
      destdir="${test.classes.dir}"
      classpathref="tests.compile.classpath"
      >
    </sf-javac-with-ant>
    <copy-useful-files src="${src.dir}" dest="${build.classes.dir}" />
  </target>
  
  <!-- 
    run the tests
    note that StartTest and any other tests that rely on
    deployment to a running system must be configured to only run
    when system.tests is set. This is so that GUMP locks them out
    
  -->
  <target name="run-tests" depends="compile-tests,want-testutil"
    if="testutil.found">
    <path id="tests.run.classpath">
      <path refid="tests.compile.classpath"/>
      <pathelement location="${test.classes.dir}"/>
      <pathelement path="${java.class.path}"/>        
    </path>

    <sf-junit 
           errorProperty="test.failed"
           failureProperty="test.failed" 
           includeantruntime="true"
           >
       <classpath 
          refid="tests.run.classpath"/>
        <sysproperty key="test.files.dir"
            value="${test.src.dir}/files" />
      <batchtest todir="${test.data.dir}" >
        <fileset dir="${test.classes.dir}">
          <include name="**/*Test.class" />
          <exclude name="**/StartTest.class" if="system.tests.enabled"/>
       </fileset>
      </batchtest>
    </sf-junit>
  </target>  

  <target name="test" depends="run-tests"
    description="run unit tests"
    if="testutil.found">
    
    <!-- generate the reports-->
    <sf-test-report data="${test.data.dir}"
      reports="${test.reports.dir}"
      failed="test.failed"/>

  </target>  
  

  <!-- this target does the extra xdocs initialisation -->
  <target name="init-xdocs" depends="init">    
    <property name="build.antdocs.dir" location="${build.dir}/xdocs"/>
    <property name="gen.dir" location="${build.antdocs.dir}/gen"/>
    <property name="gen.dir" location="${build.antdocs.dir}/gen"/>
    <property name="build.docs.dir" location="${build.antdocs.dir}/docs"/>
    <property name="build.xdocs.dir" location="${build.antdocs.dir}/xdocs"/>    
    <property name="xdocs.dir" location="${env.ANT_HOME}/proposal/xdocs" />
    <property name="src.package" value="org/smartfrog/tools/ant/" />
    <path id="xdoclet.extra.classpath">
      <path refid="smartfrog.classpath"/>
      <pathelement location="${smartfrog.tasks.jar}"/>
    </path>
    <property name="xdoclet.extra.classpath.asprop"
      refid="xdoclet.extra.classpath"/>    
  </target>  

<!-- probe for xdocs, which is only in CVS, not redist packages --> 
<target name="probe-xdocs" depends="init-xdocs" >
  <available property="xdocs.found" file="${xdocs.dir}/build.xml"/>
</target>

<target name="want-xdocs" depends="probe-xdocs">
  <fail unless="xdocs.found">
    We need the proposal/xdocs source tree from Ant in ${env.ANT_HOME}/proposal/xdocs
   </fail>
</target>



<target name="xdocs" depends="want-xdocs,compile"
  description="Run xdoclet over the ant tasks to create doc pages"
  if="xdocs.found">
  <echo>
    running xdocs with classpath=${xdoclet.extra.classpath.asprop}
  </echo>  

  <ant inheritAll="${ant.inheritAll}" inheritRefs="${ant.inheritRefs}" dir="${xdocs.dir}" 
      target="gen-and-prepare-for-docs">
    <property name="src.dir" location="${src.package}"/>
    <property name="src.root" location="src"/>
    <property name="xdoclet.extra.classpath" 
      value="${xdoclet.extra.classpath.asprop}"/>
    <property name="gen.dir" location="${gen.dir}"/>
    <property name="xdocs.dir" location="${build.xdocs.dir}"/>
    <property name="build.docs.dir" location="${build.docs.dir}"/>
  </ant>
</target>

<target name="dvsl" depends="want-xdocs">
  <ant inheritAll="${ant.inheritAll}" inheritRefs="${ant.inheritRefs}" dir="${xdocs.dir}/dvsl">
    <property name="src.dir" location="src/org/smartfrog/tools/ant/"/>
    <property name="build.dir" location="${build.antdocs.dir}"/>
    <property name="taskdocs.src" location="${gen.dir}"/>
    <property name="xdocs.dir" location="${build.xdocs.dir}"/>
    <property name="docs.dest" location="${build.docs.dir}"/>
  </ant>  
</target>  
  
</project>   
