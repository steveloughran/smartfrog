<project name="dist" 
  xmlns:core="http://smartfrog.org/build/core"
  xmlns:ac="antlib:net.sf.antcontrib"
  xmlns:sf="antlib:org.smartfrog.tools.ant"
  xmlns:m2="antlib:org.apache.maven.artifact.ant"
  >
  
  <description>
  All the targets for compiling and distributing things
  </description>
  
  <!-- import the core -->
  <import file="sftasks.xml"/>
  
  
  <!-- ========================================================== -->
  <!-- this set of classpath targets is done to allow override of -->
  <!-- any stage of the process, with all the dependent classpaths -->
  <!-- being set up right, automatically -->
    <!-- define the common compile classpath, which includes
        smartfrog and our lib dir -->
  <!-- ========================================================== -->
        
  <target name="declare-base.compile.classpath" depends="init" >  
    <path id="base.compile.classpath">
      <path refid="smartfrog.classpath"/>
    </path>
  </target>
    
  
  <target name="probe-lib-dir" depends="init">
    <available file="${lib.dir}" type="dir" property="lib.dir.found" /> 
  </target>

  <target name="declare-compile.classpath-lib-dir" 
    depends="declare-base.compile.classpath,probe-lib-dir" 
    if="lib.dir.found">  
    <path id="compile.classpath">
      <path refid="base.compile.classpath"/>
      <fileset dir="${lib.dir}">
        <include name="**/*.jar"/>
      </fileset>
    </path>    
  </target>
  
  <target name="declare-compile.classpath-no-lib-dir" 
    depends="declare-base.compile.classpath,probe-lib-dir" 
    unless="lib.dir.found">  
    <path id="compile.classpath">
      <path refid="base.compile.classpath"/>
    </path>    
  </target>
 
 <target name="declare-compile.classpath" 
    depends="declare-compile.classpath-no-lib-dir,declare-compile.classpath-lib-dir" >  
    <property name="compile.classpath.value" refid="compile.classpath"/>
    <echo level="verbose">compile.classpath=${compile.classpath.value}</echo>
  </target>
  
  <target name="declare-exec.classpath" depends="declare-compile.classpath" >  
    <path id="exec.classpath">
      <path refid="compile.classpath"/>
      <pathelement location="${build.classes.dir}"/>
    </path>    
    <property name="exec.classpath.value" refid="exec.classpath"/>
    <echo level="verbose">exec.classpath=${exec.classpath.value}</echo>
  </target>

  <target name="declare-tests.compile.classpath" 
      depends="declare-exec.classpath,smartfrog-testharness-classpath" >  
    <path id="tests.compile.classpath">
      <path refid="exec.classpath"/>
      <path refid="smartfrog.testharness-junit.classpath" />
    </path>
    <property name="tests.compile.classpath.value" refid="tests.compile.classpath"/>
    <echo level="verbose">tests.compile.classpath=${tests.compile.classpath.value}</echo>
  </target>
   
  <target name="declare-tests.run.classpath" depends="declare-tests.compile.classpath" >  
    <path id="tests.run.classpath">
      <path refid="tests.compile.classpath"/>
      <pathelement location="${test.classes.dir}"/>
    </path>
    <property name="tests.run.classpath.value" refid="tests.run.classpath"/>
    <echo level="verbose">tests.run.classpath=${tests.run.classpath.value}</echo>
  </target>

  <target name="declare-run.classpath" depends="declare-tests.run.classpath" >  
    <path id="run.classpath">
      <path refid="tests.run.classpath"/>
    </path>
  </target>


  <!-- This target explicitly lists all dependencies so that if anyone starts overriding
    declarations, it doesnt matter if they omit dependencies. After this target, all classpaths
    are defined-->  
  <target name="declare-classpaths" 
    depends=
     "declare-base.compile.classpath,declare-compile.classpath,declare-exec.classpath,declare-tests.compile.classpath,declare-tests.run.classpath,declare-tests.run.classpath,declare-run.classpath"/>
  

  <!-- ========================================================== -->
  <!-- this is an override point -->
  <!-- it does nothing but declare all the dependencies for compilation -->
  <!-- anything that overrides compile can declare a dependency on this -->
  <!-- target to get its dependencies right -->
  <!-- ========================================================== -->
  <target name="pre-compile"
      depends="init,declare-classpaths,core-tasks">
  </target>
  
  <!-- ========================================================== -->
  <!-- this is an override point -->
  <!-- compile everything, copy useful files over-->
  <!-- ========================================================== -->
  <target name="compile"
      depends="pre-compile">
      <depend srcdir="${src.dir}"
          destdir="${build.classes.dir}"
          cache="${build.dir}/depends"
          closure="yes"/>
      <core:javac
          classpathref="compile.classpath"
          srcdir="${src.dir}"
          destdir="${build.classes.dir}"
          />
      <core:copy-useful-files src="${src.dir}" dest="${build.classes.dir}"/>
  </target>

  <!-- ========================================================== -->
  <!-- this is an override point -->
  <!-- RMI compile by looking for all remote classes in the
       compiled project-->
  <!-- ========================================================== -->
  <target name="rmi" depends="compile"
      description="create the RMI classes">
      <core:rmic
          base="${build.classes.dir}"
          verify="true"
          compiler="${rmic.compiler}"
          includes="**/*.class">
          <classpath refid="compile.classpath"/>
      </core:rmic>
  </target>  
  
  <!-- override point: here we have already compiled everything
  and done the rmic compile -->
  <target name="post-compile" depends="rmi" />
  
  

  <!--
  logic to create a versioned jar name
  -->
  <target name="generate-version" depends="init">

   <!-- save everything to a file -->
   <!-- keep this in sync w/ common.xml's declaration -->
   <property name="sf.version.file" location="${build.dir}/version.properties"/>

   <propertyfile
        file="${sf.version.file}"
        comment="This is machine generated. Do Not Edit!">
      <entry  key="sf.build.date" type="date" value="now"/>
      <entry  key="sf.build.version" value = "${smartfrog.version}"/>
    </propertyfile>

    <copy file="${sf.version.file}" todir="${dist.dir}" />
    
    <!-- build the name of our JAR file from the name of the project.
      override any of this stuff for alternate naming -->
    <property name="jar.prefix" value="sf-" />
    <!-- this is the name of the outer project, not common.xml's name -->
    <property name="project.name" value="${jar.prefix}${ant.project.name}" />
    
  </target>
  
  <!--
    bypass all the self-referential stuff here.
  -->
  <target name="jar" depends="post-compile,artifact-names" >
    <jar destfile="${target.jar}" 
             basedir="${build.classes.dir}" 
             includes="**/*"/>
     <echo level="verbose">created package ${target.jar}</echo>
  </target>  
  
  <!-- ========================================================== -->
  <!-- this is an override point -->
  <!-- create the JAR ${target.jar}-->
  <!-- ========================================================== -->
  <target name="package" depends="jar,generate-version"
    description="create the JAR files">
  </target>
   
  
 <!-- ========================================================== -->
  <!-- this is an override point -->
  <!-- everything for distribution -->
  <!-- ========================================================== -->
  <target name="dist" depends="package"
    description="create a distribution">
  </target>   
  
  <!-- ========================================================== -->
  <!-- this is an override point -->
  <!-- compile everything, copy useful files over-->
  <!-- ========================================================== -->
  <target name="compile-tests"
      depends="jar,declare-tests.compile.classpath">
      <depend 
          srcdir="${test.src.dir}"
          destdir="${test.classes.dir}"
          cache="${build.test.dir}/depends"
          closure="yes"/>
      <core:javac
          srcdir="${test.src.dir}"
          destdir="${test.classes.dir}"
          classpathref="tests.compile.classpath"
          />
      <core:copy-useful-files src="${test.src.dir}" dest="${test.classes.dir}"/>
  </target>  

  
  
  
</project>  

