<?xml version="1.0"?>
<project name="testHarness" default="test">

<!--
/** (C) Copyright 1998-2004 Hewlett-Packard Development Company, LP

This library is free software; you can redistribute it and/or
modify it under the terms of the GNU Lesser General Public
License as published by the Free Software Foundation; either
version 2.1 of the License, or (at your option) any later version.

This library is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
Lesser General Public License for more details.

You should have received a copy of the GNU Lesser General Public
License along with this library; if not, write to the Free Software
Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA

For more information: www.smartfrog.org

*/
-->

<description>
  This is the build file for the test harness for smartfrog.
  It depends on smartfrog being built in the directory tree
  ../smartfrog (override smartfrog.home to change),
  and with ../smartfrog/dist/lib/smartfrog.jar existing. 
  It also needs junit3.8 or later in ANT_HOME/lib,
  and a recent copy of Xalan to turn the XML Reports into HTML.
  These reports are all placed in build/test/reports, incidentally.
  
  To run just one test, run the test target with the testcase property set to
  the full name of the test, e.g. 
    -Dtestcase=org.smartfrog.test.unit.core.coreTest
  
</description>

   <!-- override point -->
  <property file="build.properties" />
  <property environment="env" />
  
  <property name="build.dir" location="build"/>
  <property name="test.dir" location="${build.dir}/test"/>
  <property name="test.classes.dir" location="${test.dir}/classes"/>
  <property name="test.data.dir" location="${test.dir}/data"/>
  <property name="test.datafiles.dir" location="test/files"/>
  <property name="test.reports.dir" location="${test.dir}/reports"/>
  <property name="test.src.dir" location="testcases" />
  <property name="test.smartfrog.classesdir" location="${test.classes.dir}"/>
      
  <!-- 
       here we define where the smartfrog libraries live.
       this is correct for the sforge CVS repository; to work with the older
       taka CVS repository, you must have checked out the smartfrog module with
       the name 'smartfrog'.
       To run tests against smartfrog in a different location, override
       this on the commandline or in build.properties
       -->
  <property name="smartfrog.home" location="../smartfrog"/>
  <property name="dist.dir" location="${smartfrog.home}/dist"/>
  <property name="dist.lib.dir" location="${dist.dir}/lib"/>
  
  <!-- Compile options for Smartfrog Release -->
  <property name="javac.debug.mode" value="on"/> <!-- turn on compile -g -->
  <property name="javac.debug.level" value="lines,vars,source" />
  <property name="javac.runtime.target" value="1.4" />

  
  <!-- the compile time path -->
  <path id="compile.classpath">
    <fileset dir="${dist.lib.dir}" includes="**/*.jar"/>
  </path>  

  <path id="test.classpath">
    <path refid="compile.classpath"/>
    <pathelement location="${test.classes.dir}"/>
  </path>  
  
  <!-- turn on the tests. If you dont want this, set one (or both) to false)  in the unit tests-->
  <property name="system.tests" value="true" />
  <property name="unit.tests" value="false" />
  
  <condition property="system.tests.enabled">
    <istrue value="${system.tests}"/>
  </condition>
  
  <condition property="unit.tests.enabled">
    <istrue value="${unit.tests}"/>
  </condition>
  
  <!-- ========================================================== -->
  <!-- Test settings                                              -->
  <!-- ========================================================== -->
  
  <target name="init" >
    <mkdir dir="${test.dir}" />
    <mkdir dir="${test.classes.dir}" />
    <mkdir dir="${test.data.dir}" />
    <mkdir dir="${test.datafiles.dir}" />
    <mkdir dir="${test.reports.dir}" />
    <mkdir dir="${test.src.dir}"  />
  </target>

  <target name="clean" description="clean up the test directories only">
    <delete dir="${test.dir}" />    
  </target>
  
  <target name="verify-smartfrog" >
    <available 
      classname="org.smartfrog.SFSystem" 
      classpathref="compile.classpath" 
      property="sfSystem.present"/>
    <fail unless="sfSystem.present">
      Smartfrog entry point not found in ${dist.lib.dir}
    </fail>
  </target>
  
  <!-- compile the tests -->
  <target name="compile-tests" depends="verify-smartfrog,init">
    <depend srcdir="${test.src.dir}"
      destdir="${test.classes.dir}"
      cache="${test.dir}/testdepends"
      closure="yes"/>
    <javac
      debug="true"
      debuglevel="lines,vars,source"
      srcdir="${test.src.dir}"
      includes="**/*.java"
      includeAntRuntime="true"
      destdir="${test.classes.dir}"
      target="1.4"
      source="1.4"
      classpathref="compile.classpath"
      />
    <copy todir="${test.classes.dir}">
      <fileset dir="${test.src.dir}"
        includes="**/*.xml,**/*.dtd,**/*.xsd,**/*.sf,**/*.properties" />
    </copy>
  </target>

  <!-- run the tests -->
  <target name="run-tests" depends="compile-tests"
    description="run unit tests">
    <junit printsummary="no"
           errorProperty="test.failed"
           failureProperty="test.failed"
           fork="true"
           includeantruntime="true">
        <sysproperty key="test.smartfrog.classesdir"
            value="${test.smartfrog.classesdir}" />
        <jvmarg value="-enableassertions"/>
      <classpath>
        <path refid="compile.classpath"/>
        <pathelement location="${test.classes.dir}"/>
      </classpath>
      <!-- #Tests take system property parameters -->
      <!-- #Formatters for capture and display -->
      <formatter type="xml"/>
      <formatter type="brief" usefile="false"/>
      <!-- #Test case isolation technique -->
      <test name="${testcase}" if="testcase"/>
      <batchtest todir="${test.data.dir}" unless="testcase" if="system.tests.enabled">
        <!-- bulk test case -->
        <fileset dir="${test.classes.dir}">
          <include name="org/smartfrog/test/system/**/*Test.class" />
       </fileset>
      </batchtest>
      <batchtest todir="${test.data.dir}" unless="testcase" if="unit.tests.enabled">
        <!-- bulk test case -->
        <fileset dir="${test.classes.dir}">
          <include name="org/smartfrog/test/unit/**/*Test.class" />
       </fileset>
      </batchtest>
    </junit>
    
    <!-- do it -->
    <junitreport todir="${test.data.dir}">
      <fileset dir="${test.data.dir}">
        <include name="TEST-*.xml"/>
      </fileset>
      <report format="frames" todir="${test.reports.dir}"/>
    </junitreport>
    <fail if="test.failed">Unit tests failed see ${test.reports.dir}</fail>

  </target>

  <target name="test" 
    depends="run-tests"
    description="compile and run all the tests"
    />
</project>
